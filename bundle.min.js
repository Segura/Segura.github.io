var Graph=function(t){"use strict";const i=1e3/24;class s{constructor(t){this.container=t,this.debounces={},this.events={},this.sendEvent=this.sendEvent.bind(this)}static subscribeTo(t,i,s){t.addEventListener(i,s,!1)}static notifyTo(t,i,s={}){const e=new CustomEvent(i,{detail:s,bubbles:!0,cancelable:!0});t.dispatchEvent(e)}subscribe(t,i){s.subscribeTo(this.container,t,i)}sendEvent(t){this.events[t]?(s.notifyTo(this.container,t,this.events[t]),this.events[t]=null,this.debounces[t]=setTimeout(()=>this.sendEvent(t),i)):this.debounces[t]=null}notify(t,e={}){this.debounces[t]?this.events[t]=e:(s.notifyTo(this.container,t,e),this.debounces[t]=setTimeout(()=>this.sendEvent(t),i))}}class e extends s{constructor(t,i,s={}){super(t),this.canvas=document.createElement("canvas"),this.canvas.classList.add(i),this.context=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.config=Object.assign(this.getDefaultConfig(),s),this.animationStart=!1,this.animation={},this.clear=this.clear.bind(this),this.draw=this.draw.bind(this),this.animateTick=this.animateTick.bind(this),this.resize()}getDefaultConfig(){return{padding:{top:0,bottom:0,left:0,right:0}}}draw(t){}initCanvas(){this.context.lineWidth=this.config.lineWidth}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}animateProperties(t,i,s){this.animation={draw:t,start:performance.now(),duration:s,fromValues:Object.keys(i).reduce((t,i)=>({...t,[i]:this[i]}),{}),toValues:i},this.animationStart||(requestAnimationFrame(this.animateTick),this.animationStart=!0)}animateTick(t){const i=Math.min(Math.max((t-this.animation.start)/this.animation.duration,0),1);Object.keys(this.animation.toValues).forEach(t=>{this[t]=this.animation.fromValues[t]+(this.animation.toValues[t]-this.animation.fromValues[t])*i}),this.animation.draw(i),i<1?requestAnimationFrame(this.animateTick):this.animationStart=!1}animate(t,i=0){const s=performance.now();requestAnimationFrame(function e(h){const n=Math.min(Math.max((h-s)/i,0),1);t(n),n<1&&requestAnimationFrame(e)})}getTop(){return this.config.padding.top}getLeft(){return this.config.padding.left}getRight(){return this.config.padding.left+this.canvas.drawableWidth}getBottom(){return this.canvas.height-this.config.padding.bottom}getFontSize(){const t=Math.round(this.config.fontSizeRatio*this.canvas.width/100);return Math.min(Math.max(t,this.config.minFontSize),this.config.maxFontSize)}resize(){const{left:t=0,top:i=0,right:s=0,bottom:e=0}=this.config.padding;this.canvas.width=this.canvas.clientWidth,this.canvas.drawableWidth=this.canvas.clientWidth-t-s,this.canvas.drawableHeight=this.canvas.clientWidth*this.config.hToWRatio,this.canvas.height=this.canvas.drawableHeight+i+e,this.initCanvas()}}class h extends e{constructor(t,i,s={}){super(t,"lines",s),this.drawLine=this.drawLine.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.lines=i,this.ratio=0,this.linesOpacity={},this.animate(this.draw)}changeBounds(t,i){this.min||(this.min=t),this.max||(this.max=i);const s=this.canvas.drawableHeight/(i-t);this.animateProperties(this.draw,{min:t,max:i,ratio:s},300)}changeRange(t,i){this.left=t,this.right=i,this.step=this.canvas.drawableWidth/(this.right-this.left),this.animate(this.draw)}draw(){this.clear(),this.lines.forEach(this.drawLine)}drawLine(t){const i=this.linesOpacity[t.name];this.context.globalAlpha=isFinite(i)?i:1,this.context.strokeStyle=t.color,this.context.beginPath(),this.context.moveTo(this.getLeft(),this.getBottom()-this.ratio*(t.data[this.left]-this.min));for(let i=this.left;i<=this.right;i++)this.context.lineTo((i-this.left)*this.step+this.getLeft(),this.getBottom()-this.ratio*(t.data[i]-this.min));this.context.stroke(),this.context.globalAlpha=1}getVisibleLines(){return this.lines.filter(t=>t.isVisible)}setLineState(t,i){const s=i?0:1;this.animate(i=>{this.linesOpacity[t]=Math.abs(i-s),this.draw()},300)}onResize(){super.resize(),this.ratio=this.canvas.drawableHeight/(this.max-this.min),this.config.paddingBottom=this.min*this.ratio,this.step=this.canvas.drawableWidth/(this.right-this.left),this.draw()}handleMouseMove(t){if(0===t.buttons){const i=Math.round((t.pageX-this.canvas.parentNode.offsetLeft)/this.step+this.left);if(i>this.right)return;const s=this.getVisibleLines().reduce((t,s)=>(t.lines.push({y:this.getBottom()-Math.round((s.data[i]-this.min)*this.ratio),value:s.data[i],color:s.color,title:s.title}),t),{lines:[],x:(i-this.left)*this.step+this.getLeft(),index:i,show:!0});this.notify("toggleDetails",s)}}handleMouseLeave(){this.notify("toggleDetails",{show:!1})}}const n=(t,i=null)=>{const s=document.createElement("div");return s.classList.add(i),t.appendChild(s),s},a=(t,i={})=>t?new Intl.DateTimeFormat(i.locale,i.options).format(new Date(t)):"";class o extends e{constructor(t,i,s,e,h={}){super(t,"xaxis",h),this.data=i,this.linesCount=h.linesCount,this.draw=this.draw.bind(this),this.draw2=this.draw2.bind(this),this.ratio=0,this.offset=0,this.changeRange(s,e)}getDefaultConfig(){return{textMargin:16,chartPadding:4}}initCanvas(){this.context.fillStyle="rgba(150,162,170,0.7)",this.context.font=`${this.getFontSize()}px Ubuntu`,this.context.textAlign="center"}onResize(){super.resize(),this.calculateRatio(),this.animate(this.draw)}calculateRatio(){this.ratio=this.canvas.drawableWidth/(this.right-this.left)}draw(){this.clear(),this.context.globalAlpha=this.alpha;for(let t=0;t<this.linesCount;t++){const i=Math.max(Math.floor(this.left+t*this.step),1),s=t*this.step*this.ratio+this.getLeft();this.context.fillText(a(this.data[i],this.config.formatOptions),s,this.getBottom())}this.context.globalAlpha=1-this.alpha;for(let t=0;t<this.linesCount;t++){const i=Math.max(Math.floor(this.left+t*this.oldStep),1),s=t*this.oldStep*this.ratio+this.getLeft();this.context.fillText(a(this.data[i],this.config.formatOptions),s,this.getBottom())}}draw2(){this.clear(),this.context.globalAlpha=1;for(let t=0;t<this.linesCount+1;t++){const i=Math.max(Math.floor(t*this.step+Math.trunc((this.left+this.offset)/this.step)*this.step),1),s=(t*this.step-(this.left+this.offset)%this.step)*this.ratio+this.getLeft();this.context.fillText(a(this.data[i],this.config.formatOptions),s,this.getBottom())}}changeRange(t,i){if(this.left!==t||this.right!==i)if(i-t==this.right-this.left)this.offset=this.offset-(t-this.left),this.left=t,this.right=i,this.animateProperties(this.draw2,{alpha:1,offset:0},300);else{this.oldStep=this.step,this.alpha=.5,this.left=t,this.right=i,this.step=(i-t)/this.linesCount;const s=this.canvas.drawableWidth/(this.right-this.left);this.animateProperties(this.draw,{alpha:1,ratio:s},300)}}}class c extends e{constructor(t,i,s,e={}){super(t,"yaxis",e),this.linesCount=e.linesCount,this.draw=this.draw.bind(this),this.ratio=0,this.changeBounds(i,s)}getDefaultConfig(){return{textMargin:16,chartPadding:4}}initCanvas(){this.context.strokeStyle="rgba(200,200,200,0.8)",this.context.strokeWidth=2,this.context.fillStyle="rgba(150,162,170,0.7)",this.context.font=`${this.getFontSize()}px Ubuntu`}onResize(){super.resize(),this.calculateRatio(),this.animate(this.draw)}calculateRatio(){this.ratio=this.canvas.drawableHeight/(this.max-this.min)}draw(){this.clear(),this.context.globalAlpha=this.alpha;for(let t=0;t<=this.linesCount;t++){const i=this.getBottom()-t*this.step*this.ratio;this.drawLine(i,Math.floor(this.min+t*this.step))}this.context.globalAlpha=1-this.alpha;for(let t=0;t<=this.linesCount;t++){const i=this.getBottom()-t*this.oldStep*this.ratio;this.drawLine(i,Math.floor(this.min+t*this.oldStep))}}drawLine(t,i){this.context.beginPath(),this.context.moveTo(this.getLeft(),t),this.context.lineTo(this.getRight(),t),this.context.stroke(),this.context.fillText(i.toString(),this.getLeft(),t-this.config.textMargin)}changeBounds(t,i){if(this.min===t&&this.max===i)return;this.oldStep=this.step,this.alpha=.5,this.min=t,this.max=i,this.step=(i-t)/this.linesCount;const s=this.canvas.drawableHeight/(this.max-this.min);this.animateProperties(this.draw,{alpha:1,ratio:s},300)}}class r{constructor(t,i){this.container=t,this.config=i,this.popup=this.createPopup(),this.init()}createPopup(){const t=document.createElement("div");return t.classList.add("popup"),this.container.appendChild(t),t}setConfig(t){this.config=t,this.init()}init(){this.popup.innerHTML=`<h2 class="date">${this.config.header}</h2>`;let t='<div class="popup-data">';this.config.lines.forEach(i=>{t+=`<div style="color: ${i.color}"><h5 class="label">${i.value}</h5><span class="value">${i.title}</span></div>`}),this.popup.innerHTML+=`${t}</div>`,this.popup.style.fontSize=`${this.config.fontSize}px`,this.popup.classList.add("hidden"),this.popup.style.backgroundColor=getComputedStyle(document.body).getPropertyValue("background-color");const i=Math.round(this.config.position.x-this.popup.getBoundingClientRect().width*this.config.ratio),s=this.config.position.y-this.popup.getBoundingClientRect().height;this.popup.style.transform=`translate(${i}px, calc(${s}px - 1em))`}show(){this.popup.classList.add("visible")}hide(){this.popup.classList.remove("visible")}}class l extends e{constructor(t,i,s={}){super(t,"details",s),this.xAxis=i,this.popup=new r(this.container,{...this.config,header:"",lines:[],position:{x:0,y:0}}),this.drawPoint=this.drawPoint.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.toggle=this.toggle.bind(this),this.subscribe("toggleDetails",this.toggle)}show(t){const{x:i,lines:s,index:e}=t.detail;this.x=i,this.lines=s,this.y=this.getMinY(),this.index=e,this.draw()}draw(){this.clear(),this.drawLine(),this.lines.forEach(this.drawPoint),this.popup.setConfig({...this.config,header:a(this.xAxis[this.index],this.config.formatOptions),lines:this.lines,ratio:this.x/this.canvas.drawableWidth,position:{x:this.x,y:this.y},fontSize:this.getFontSize()}),this.popup.show()}getMinY(){return this.lines.reduce((t,i)=>Math.min(t,i.y),Number.MAX_SAFE_INTEGER)}hide(){this.clear(),this.popup.hide()}toggle(t){t.detail.show?this.show(t):this.hide()}drawLine(){this.context.strokeStyle="rgba(200,200,200,0.25)",this.context.beginPath(),this.context.moveTo(this.x,0),this.context.lineTo(this.x,this.getBottom()),this.context.stroke()}drawPoint(t){this.drawCircle(t.color,this.x,t.y,7);const i=getComputedStyle(document.body).getPropertyValue("background-color");this.drawCircle(i,this.x,t.y,7-this.config.lineWidth)}drawCircle(t,i,s,e){this.context.fillStyle=t,this.context.beginPath(),this.context.arc(i,s,e,0,2*Math.PI),this.context.fill()}}class d{constructor(t,i,s={}){this.container=n(t,"main-chart"),this.x=i.xAxis,this.y=i.yAxis,this.left=1,this.right=this.x.length-1,this.recalculateYBounds(),this.config=Object.assign(d.DEFAULT_CONFIG,s),this.xAxis=new o(this.container,this.x,this.left,this.right,this.config),this.yAxis=new c(this.container,this.min,this.max,this.config),this.lines=new h(this.container,this.y,this.config),this.lines.changeBounds(this.min,this.max),this.lines.changeRange(this.left,this.right),this.lines.subscribe("mousemove",this.lines.handleMouseMove),this.lines.subscribe("mouseleave",this.lines.handleMouseLeave),this.lines.subscribe("scroll",this.lines.handleMouseLeave),this.details=new l(this.container,this.x,this.config),window.addEventListener("resize",this.onResize.bind(this)),t.addEventListener("seriaToggle",this.onToggleLine.bind(this),!1),t.addEventListener("changeRange",this.onChangeRange.bind(this),!1)}static get DEFAULT_CONFIG(){return{linesCount:4,hToWRatio:.25,lineWidth:3,padding:{top:40,bottom:20,left:0,right:0},formatOptions:{locale:navigator.language,options:{weekday:"short",month:"short",day:"numeric"}},fontSizeRatio:1.8,minFontSize:12,maxFontSize:22}}onResize(){this.xAxis.onResize(),this.yAxis.onResize(),this.lines.onResize(),this.details.resize()}onChangeRange(t){const{start:i,end:s}=t.detail;this.left=i,this.right=s,this.recalculateYBounds(),this.lines.changeBounds(this.min,this.max),this.lines.changeRange(this.left,this.right),this.xAxis.changeRange(this.left,this.right),this.yAxis.changeBounds(this.min,this.max)}recalculateYBounds(){let t=Number.MIN_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER;this.y.filter(t=>t.isVisible).forEach(s=>{for(let e=this.left;e<=this.right;e++){const h=s.data[e];h>t?t=h:h<i&&(i=h)}}),this.max=t,this.min=i}onToggleLine(t){const{name:i,value:s}=t.detail;this.changeVisible(i,s),this.recalculateYBounds(),this.lines.setLineState(i,s),this.lines.changeBounds(this.min,this.max),this.yAxis.changeBounds(this.min,this.max)}changeVisible(t,i){for(let s=0;s<this.y.length;s++)if(this.y[s].name===t){this.y[s].isVisible=i;break}}}class g extends e{constructor(t,i){super(t,"scope",i),this.maxX=i.maxX,this.initCanvas(),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.releaseDrag=this.releaseDrag.bind(this),this.subscribeToEvents(),this.draw()}initCanvas(){this.scopeOptions={scopeStart:this.canvas.width/3,scopeEnd:this.canvas.width/2,vStrokeWidth:this.canvas.width/150,canDrag:!1,shouldDrag:!1,canResize:!1,shouldResize:!1},this.scopeOptions.halfVStrokeWidth=this.scopeOptions.vStrokeWidth/2,this.scopeOptions.hStrokeWidth=this.scopeOptions.halfVStrokeWidth/4}draw(){this.clear();const{scopeStart:t,scopeEnd:i,hStrokeWidth:s,halfVStrokeWidth:e,vStrokeWidth:h}=this.scopeOptions;this.context.fillStyle="rgba(0,0,0,0.1)",this.context.fillRect(0,0,t,this.canvas.height),this.context.strokeStyle="rgba(154,211,251,0.337)",this.context.beginPath(),this.context.moveTo(t,0),this.context.lineWidth=s,this.context.lineTo(i-e,0),this.context.lineWidth=h,this.context.lineTo(i-e,this.canvas.height),this.context.lineWidth=s,this.context.lineTo(t+e,this.canvas.height),this.context.lineWidth=h,this.context.lineTo(t+e,0),this.context.stroke(),this.context.fillStyle="rgba(0,0,0,0.1)",this.context.fillRect(i,0,this.canvas.width,this.canvas.height),this.notifyChanges(this.scopeOptions)}handleMouseDown(t){0===t.button?(this.scopeOptions.shouldDrag=this.scopeOptions.canDrag,this.scopeOptions.shouldResize=this.scopeOptions.canResize,this.scopeOptions.isLeftSide=t.layerX<this.scopeOptions.scopeStart+this.scopeOptions.vStrokeWidth,this.scopeOptions.resizeModifier=this.scopeOptions.isLeftSide?-1:1):(this.scopeOptions.shouldDrag=!1,this.scopeOptions.shouldResize=!1)}shouldDrag(t){const{scopeStart:i,scopeEnd:s,vStrokeWidth:e}=this.scopeOptions;return t>i+e&&t<s-e}shouldResize(t){const{scopeStart:i,scopeEnd:s}=this.scopeOptions;return t>i&&t<s}releaseDrag(){this.scopeOptions.shouldDrag=!1,this.scopeOptions.shouldResize=!1}handleMouseMove(t){const{shouldDrag:i,shouldResize:s,scopeStart:e,scopeEnd:h}=this.scopeOptions,n=t.pageX-this.canvas.parentNode.offsetLeft;t.preventDefault(),t.stopPropagation(),n<0&&e===this.getLeft()||n>=this.canvas.width&&h===this.getRight()||(this.scopeOptions.canDrag=this.shouldDrag(n),this.scopeOptions.canResize=!this.scopeOptions.canDrag&&this.shouldResize(n),this.canvas.style.cursor="auto",this.scopeOptions.canDrag&&(this.canvas.style.cursor="move"),this.scopeOptions.canResize&&(this.canvas.style.cursor="ew-resize"),i&&t.movementX&&this.drag(t),s&&t.movementX&&this.resizeScope(t))}drag(t){const{scopeStart:i,scopeEnd:s}=this.scopeOptions;let e=i+t.movementX,h=s+t.movementX;e<0&&(e=0,h=s-i),h>this.canvas.width&&(e=(h=this.canvas.width)-(s-i)),e!==i&&h!==s&&(this.scopeOptions.scopeStart=e,this.scopeOptions.scopeEnd=h,this.draw())}resizeScope(t){const{resizeModifier:i,scopeStart:s,scopeEnd:e,isLeftSide:h,vStrokeWidth:n}=this.scopeOptions;let a=s,o=e;h?(a=s+t.movementX)<0&&(a=0):(o=e+t.movementX*i)>this.canvas.width&&(o=this.canvas.width),(a!==s||o!==e)&&o>a+2*n&&(this.scopeOptions.scopeStart=a,this.scopeOptions.scopeEnd=o,this.draw())}notifyChanges(t){const i=this.maxX/this.canvas.width;this.notify("changeRange",{start:Math.floor(1+i*t.scopeStart),end:Math.floor(i*t.scopeEnd)})}subscribeToEvents(){this.subscribe("mousedown",this.handleMouseDown),s.subscribeTo(document,"mousemove",this.handleMouseMove),s.subscribeTo(document,"mouseup",this.releaseDrag)}onResize(){super.resize(),this.initCanvas(),this.draw()}}class p{constructor(t,i,s={}){this.container=n(t,"main-chart"),this.x=i.xAxis,this.y=i.yAxis,this.left=1,this.right=i.xAxis.length-1,this.recalculateYBounds(),this.config=Object.assign(p.DEFAULT_CONFIG,s,{maxX:this.x.length-1}),this.lines=new h(this.container,this.y,this.config),this.lines.changeBounds(this.min,this.max),this.lines.changeRange(this.left,this.right),this.scope=new g(this.container,this.config),window.addEventListener("resize",this.onResize.bind(this)),t.addEventListener("seriaToggle",this.onToggleLine.bind(this),!1)}static get DEFAULT_CONFIG(){return{hToWRatio:.05,lineWidth:1,padding:{top:10,bottom:10,left:0,right:0}}}onResize(){this.scope.onResize(),this.lines.onResize()}recalculateYBounds(){let t=Number.MIN_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER;this.y.filter(t=>t.isVisible).forEach(s=>{for(let e=this.left;e<this.right;e++){const h=s.data[e];h>t?t=h:h<i&&(i=h)}}),this.max=t,this.min=i}changeVisible(t,i){for(let s=0;s<this.y.length;s++)if(this.y[s].name===t){this.y[s].isVisible=i;break}}onToggleLine(t){const{name:i,value:s}=t.detail;this.changeVisible(i,s),this.recalculateYBounds(),this.lines.setLineState(i,s),this.lines.changeBounds(this.min,this.max)}}class u extends s{static createContainer(){let t=document.createElement("div");return t.className="control-container",t}constructor(t,i={data:[]}){super(t),this.config=i,this.activeCount=0,this.createControl=this.createControl.bind(this),this.draw()}draw(){const t=u.createContainer();this.config.data.forEach(i=>{t.appendChild(this.createControl(i))}),this.container.appendChild(t)}handleOnToggle(t){return i=>{if(1===this.activeCount&&!i.target.checked)return i.preventDefault(),i.stopPropagation(),void(i.target.checked=!0);this.activeCount+=i.target.checked?1:-1,1===this.activeCount?this.container.classList.add("control-container-disabled"):this.container.classList.remove("control-container-disabled"),this.notify("seriaToggle",{name:t,value:i.target.checked})}}createControl(t={}){let i=document.createElement("label");return i.className="seria-toggler",i.innerHTML=`<input type="checkbox" checked name="${t.name}"/><span class="seria-toggler-checkmark" style="color: ${t.color}"></span><span>${t.title}</span>`,i.onchange=this.handleOnToggle(t.name),this.activeCount++,i}}class f{constructor(t,i,s={}){this.container=t,this.data=i,this.config=s,this.container.appendChild(this.createTitle()),this.main=new d(this.container,this.data,s),this.selector=new p(this.container,this.data,s),this.controls=new u(this.container,{data:i.yAxis})}createTitle(){let t=document.createElement("h1");return t.innerText=this.config.header,t.classList.add("chart-title"),t}}const m=(t,i={})=>{const s=Object.keys(i.names);return{xAxis:i.columns.find(t=>-1===s.indexOf(t[0])),yAxis:s.map(t=>({name:t,color:i.colors[t],title:i.names[t],data:i.columns.find(i=>i[0]===t),isVisible:!0}))}};return t.draw=((t,i,s={})=>{i.then(i=>{const e=m(t,i);new f(t,e,s)})}),t}({});